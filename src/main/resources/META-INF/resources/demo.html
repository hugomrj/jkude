<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>KUDE PDF</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <script>

        async function enviarXML(event) {
            event.preventDefault();

            const textXML = document.getElementById("xml").value.trim();
            const fileInput = document.getElementById("xmlFile");
            const file = fileInput.files[0];
            const tipoReporte = document.getElementById("tipoReporte").value;

            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;

            let xmlContent = "";

            if (file) {
                xmlContent = await file.text();
            } else if (textXML) {
                xmlContent = textXML;
            } else {
                alert("Debes pegar un XML o seleccionar un archivo.");
                return;
            }

            try {
                // Loading
                submitBtn.textContent = "Generando PDF...";
                submitBtn.disabled = true;

                const baseURL = window.location.origin;
                const currentPath = window.location.pathname;

                let apiURL;

                // Proxy (https://japo.click/jkude/demo.html)
                if (currentPath.includes('/jkude/')) {
                    apiURL = tipoReporte === "TICKET"
                        ? `${baseURL}/jkude/kude/ticket`
                        : `${baseURL}/jkude/kude/pdf`;
                }
                // Local (http://localhost:8001/demo.html)
                else {
                    apiURL = tipoReporte === "TICKET"
                        ? `${baseURL}/kude/ticket`
                        : `${baseURL}/kude/pdf`;
                }

                console.log('Enviando a:', apiURL);

                const response = await fetch(apiURL, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/xml",
                        "Accept": "application/pdf"
                    },
                    body: xmlContent
                });

                if (!response.ok) {
                    throw new Error(`Error ${response.status}`);
                }

                const blob = await response.blob();

                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                const filename = `${tipoReporte.toLowerCase()}-${timestamp}.pdf`;

                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);

                console.log('PDF descargado correctamente');

            } catch (error) {
                console.error('Error:', error);
                alert('Error al generar el PDF: ' + error.message);
            } finally {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        }



                // Función para cargar XML de ejemplo automáticamente
                function cargarEjemplo() {
                    const xmlEjemplo = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
        <rLoteDE><rDE xmlns="http://ekuatia.set.gov.py/sifen/xsd" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://ekuatia.set.gov.py/sifen/xsd siRecepDE_v150.xsd">
            <dVerFor>150</dVerFor>
            <DE Id="01800140664049001005128912025081617262700806">
                <dDVId>6</dDVId>
                <dFecFirma>2025-08-16T14:23:06</dFecFirma>
                <dSisFact>1</dSisFact>
                <gOpeDE>
                    <iTipEmi>1</iTipEmi>
                    <dDesTipEmi>Normal</dDesTipEmi>
                    <dCodSeg>726270080</dCodSeg>
                </gOpeDE>
                <gTimb>
                    <iTiDE>1</iTiDE>
                    <dDesTiDE>Factura electrónica</dDesTiDE>
                    <dNumTim>16284685</dNumTim>
                    <dEst>049</dEst>
                    <dPunExp>001</dPunExp>
                    <dNumDoc>0051289</dNumDoc>
                    <dFeIniT>2023-03-16</dFeIniT>
                </gTimb>
                <gDatGralOpe>
                    <dFeEmiDE>2025-08-16T15:04:36</dFeEmiDE>
                    <gOpeCom>
                        <iTipTra>1</iTipTra>
                        <dDesTipTra>Venta de mercadería</dDesTipTra>
                        <iTImp>1</iTImp>
                        <dDesTImp>IVA</dDesTImp>
                        <cMoneOpe>PYG</cMoneOpe>
                        <dDesMoneOpe>Guarani</dDesMoneOpe>
                    </gOpeCom>
                    <gEmis>
                        <dRucEm>80014066</dRucEm>
                        <dDVEmi>4</dDVEmi>
                        <iTipCont>1</iTipCont>
                        <cTipReg>2</cTipReg>
                        <dNomEmi>SERVICIOS RAPIDOS DEL PARAGUAY S.A.</dNomEmi>
                        <dNomFanEmi>SERVICIOS RAPIDOS DEL PARAGUAY S.A.</dNomFanEmi>
                        <dDirEmi>AVDA. RUTA PY 01 (EX ACCESO SUR)  Y FORTIN TOLEDO</dDirEmi>
                        <dNumCas>9999</dNumCas>
                        <dCompDir1>N/A</dCompDir1>
                        <dCompDir2>N/A</dCompDir2>
                        <cDepEmi>12</cDepEmi>
                        <dDesDepEmi>CENTRAL</dDesDepEmi>
                        <cDisEmi>161</cDisEmi>
                        <dDesDisEmi>ÑEMBY</dDesDisEmi>
                        <cCiuEmi>5977</cCiuEmi>
                        <dDesCiuEmi>CERRO ÑEMBY</dDesCiuEmi>
                        <dTelEmi>0974200048</dTelEmi>
                        <dEmailE>fesrpa@mcd.com.py</dEmailE>
                        <dDenSuc>ÑEMBY</dDenSuc>
                        <gActEco>
                            <cActEco>56101</cActEco>
                            <dDesActEco>RESTAURANTES Y PARRILLADAS</dDesActEco>
                        </gActEco>
                    </gEmis>
                    <gDatRec>
                        <iNatRec>1</iNatRec>
                        <iTiOpe>2</iTiOpe>
                        <cPaisRec>PRY</cPaisRec>
                        <dDesPaisRe>Paraguay</dDesPaisRe>
                        <iTiContRec>1</iTiContRec>
                        <dRucRec>3437941</dRucRec>
                        <dDVRec>0</dDVRec>
                        <dNomRec>HUGO ROMERO</dNomRec>
                        <dEmailRec>HUGOMRJ@gmail.com</dEmailRec>
                    </gDatRec>
                </gDatGralOpe>
                <gDtipDE>
                    <gCamFE>
                        <iIndPres>1</iIndPres>
                        <dDesIndPres>Operación presencial</dDesIndPres>
                    </gCamFE>
                    <gCamCond>
                        <iCondOpe>1</iCondOpe>
                        <dDCondOpe>Contado</dDCondOpe>
                        <gPaConEIni>
                            <iTiPago>21</iTiPago>
                            <dDesTiPag>Pago electrónico</dDesTiPag>
                            <dMonTiPag>85000.0000</dMonTiPag>
                            <cMoneTiPag>PYG</cMoneTiPag>
                            <dDMoneTiPag>Guarani</dDMoneTiPag>
                        </gPaConEIni>
                    </gCamCond>
                    <gCamItem>
                        <dCodInt>110</dCodInt>
                        <dDesProSer>CajFelHamQue</dDesProSer>
                        <cUniMed>77</cUniMed>
                        <dDesUniMed>UNI</dDesUniMed>
                        <dCantProSer>1.0000</dCantProSer>
                        <gValorItem>
                            <dPUniProSer>32000.00000000</dPUniProSer>
                            <dTotBruOpeItem>32000.00000000</dTotBruOpeItem>
                            <gValorRestaItem>
                                <dDescItem>4500.00000000</dDescItem>
                                <dPorcDesIt>14.06000000</dPorcDesIt>
                                <dTotOpeItem>27500.00000000</dTotOpeItem>
                            </gValorRestaItem>
                        </gValorItem>
                        <gCamIVA>
                            <iAfecIVA>1</iAfecIVA>
                            <dDesAfecIVA>Gravado IVA</dDesAfecIVA>
                            <dPropIVA>100.00000000</dPropIVA>
                            <dTasaIVA>10</dTasaIVA>
                            <dBasGravIVA>25000.00000000</dBasGravIVA>
                            <dLiqIVAItem>2500.00000000</dLiqIVAItem>
                            <dBasExe>0.00000000</dBasExe>
                        </gCamIVA>
                    </gCamItem>
                    <gCamItem>
                        <dCodInt>110</dCodInt>
                        <dDesProSer>CajFelHamQue</dDesProSer>
                        <cUniMed>77</cUniMed>
                        <dDesUniMed>UNI</dDesUniMed>
                        <dCantProSer>1.0000</dCantProSer>
                        <gValorItem>
                            <dPUniProSer>32000.00000000</dPUniProSer>
                            <dTotBruOpeItem>32000.00000000</dTotBruOpeItem>
                            <gValorRestaItem>
                                <dDescItem>4500.00000000</dDescItem>
                                <dPorcDesIt>14.06000000</dPorcDesIt>
                                <dTotOpeItem>27500.00000000</dTotOpeItem>
                            </gValorRestaItem>
                        </gValorItem>
                        <gCamIVA>
                            <iAfecIVA>1</iAfecIVA>
                            <dDesAfecIVA>Gravado IVA</dDesAfecIVA>
                            <dPropIVA>100.00000000</dPropIVA>
                            <dTasaIVA>10</dTasaIVA>
                            <dBasGravIVA>25000.00000000</dBasGravIVA>
                            <dLiqIVAItem>2500.00000000</dLiqIVAItem>
                            <dBasExe>0.00000000</dBasExe>
                        </gCamIVA>
                    </gCamItem>
                    <gCamItem>
                        <dCodInt>10</dCodInt>
                        <dDesProSer>CboBigMacMd</dDesProSer>
                        <cUniMed>77</cUniMed>
                        <dDesUniMed>UNI</dDesUniMed>
                        <dCantProSer>1.0000</dCantProSer>
                        <gValorItem>
                            <dPUniProSer>36500.00000000</dPUniProSer>
                            <dTotBruOpeItem>36500.00000000</dTotBruOpeItem>
                            <gValorRestaItem>
                                <dDescItem>6500.00000000</dDescItem>
                                <dPorcDesIt>17.81000000</dPorcDesIt>
                                <dTotOpeItem>30000.00000000</dTotOpeItem>
                            </gValorRestaItem>
                        </gValorItem>
                        <gCamIVA>
                            <iAfecIVA>1</iAfecIVA>
                            <dDesAfecIVA>Gravado IVA</dDesAfecIVA>
                            <dPropIVA>100.00000000</dPropIVA>
                            <dTasaIVA>10</dTasaIVA>
                            <dBasGravIVA>27272.73000000</dBasGravIVA>
                            <dLiqIVAItem>2727.27300000</dLiqIVAItem>
                            <dBasExe>0.00000000</dBasExe>
                        </gCamIVA>
                    </gCamItem>
                </gDtipDE>
                <gTotSub>
                    <dSubExe>0.00000000</dSubExe>
                    <dSub5>0.00000000</dSub5>
                    <dSub10>85000.00000000</dSub10>
                    <dTotOpe>85000.00000000</dTotOpe>
                    <dTotDesc>15500.00000000</dTotDesc>
                    <dTotDescGlotem>0.00000000</dTotDescGlotem>
                    <dTotAntItem>0.00000000</dTotAntItem>
                    <dTotAnt>0.00000000</dTotAnt>
                    <dPorcDescTotal>0.00000000</dPorcDescTotal>
                    <dDescTotal>15500.00000000</dDescTotal>
                    <dAnticipo>0.00000000</dAnticipo>
                    <dRedon>0.0000</dRedon>
                    <dTotGralOpe>85000.00000000</dTotGralOpe>
                    <dIVA5>0.00000000</dIVA5>
                    <dIVA10>7727.00000000</dIVA10>
                    <dTotIVA>7727.00000000</dTotIVA>
                    <dBaseGrav5>0.00000000</dBaseGrav5>
                    <dBaseGrav10>77273.00000000</dBaseGrav10>
                    <dTBasGraIVA>77273.00000000</dTBasGraIVA>
                </gTotSub>
            </DE>
        </rDE>
        </rLoteDE>`;

                    document.getElementById("xml").value = xmlEjemplo;

                }

                // Cargar automáticamente al abrir la página
                window.onload = function() {
                    // cargarEjemplo();
                };
    </script>
</head>

<body class="bg-gray-100 flex items-center justify-center min-h-screen p-6">
<div class="bg-white shadow-xl rounded-2xl p-10 w-full max-w-4xl border border-gray-200">
    <h1 class="text-2xl font-semibold text-gray-800 mb-6 text-center">
        Generar KUDE (PDF)
    </h1>

    <div class="mb-4 text-center">
        <button
                onclick="cargarEjemplo()"
                class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-medium transition"
        >
            Cargar XML de Ejemplo
        </button>
    </div>

    <form onsubmit="enviarXML(event)" class="space-y-5">
        <label class="block text-gray-700 font-medium">Pegar XML:</label>
        <textarea
                id="xml"
                rows="8"
                class="w-full p-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-400 focus:outline-none font-mono"
                placeholder="Pegá aquí el XML..."></textarea>

        <div class="text-center text-gray-600 font-medium">— ó —</div>

        <label class="block text-gray-700 font-medium">Subir archivo XML:</label>
        <input
                id="xmlFile"
                type="file"
                accept=".xml"
                class="w-full border border-gray-300 p-3 rounded-xl bg-gray-50 cursor-pointer"
        />

        <label class="block text-gray-700 font-medium">Tipo de reporte:</label>
        <select
                id="tipoReporte"
                class="w-full p-3 border border-gray-300 rounded-xl bg-white"
        >
            <option value="KUDE">KUDE</option>
            <option value="TICKET">Ticket</option>
        </select>



        <button
                type="submit"
                class="w-full bg-blue-600 hover:bg-blue-700 text-white py-4 rounded-xl font-medium transition shadow-md text-lg"
        >
            Descargar PDF
        </button>
    </form>
</div>
</body>
</html>