<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>KUDE PDF</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        async function enviarXML(event) {
            event.preventDefault();

            const textXML = document.getElementById("xml").value.trim();
            const fileInput = document.getElementById("xmlFile");
            const file = fileInput.files[0];
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;

            let xmlContent = "";

            if (file) {
                xmlContent = await file.text();
            } else if (textXML) {
                xmlContent = textXML;
            } else {
                alert("Debes pegar un XML o seleccionar un archivo.");
                return;
            }

            try {
                // Mostrar loading
                submitBtn.textContent = "Generando PDF...";
                submitBtn.disabled = true;

                // DETECTAR RUTA CORRECTA AUTOMÁTICAMENTE
                const baseURL = window.location.origin;
                const currentPath = window.location.pathname;

                let apiURL;

                // Si estamos en el proxy (https://japo.click/jkude/demo.html)
                if (currentPath.includes('/jkude/')) {
                    apiURL = `${baseURL}/jkude/kude/pdf`;
                }
                // Si estamos en local directo (http://localhost:8001/demo.html)
                else {
                    apiURL = `${baseURL}/kude/pdf`;
                }

                console.log('Enviando a:', apiURL);

                const response = await fetch(apiURL, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/xml",
                        "Accept": "application/pdf"
                    },
                    body: xmlContent
                });

                if (!response.ok) {
                    throw new Error(`Error ${response.status}`);
                }

                const blob = await response.blob();

                // Descargar automáticamente
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                const filename = `kude-${timestamp}.pdf`;

                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);

                console.log('PDF descargado correctamente');

            } catch (error) {
                console.error('Error:', error);
                alert('Error al generar el PDF: ' + error.message);
            } finally {
                // Restaurar botón
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        }
    </script>
</head>

<body class="bg-gray-100 flex items-center justify-center min-h-screen p-6">
<div class="bg-white shadow-xl rounded-2xl p-10 w-full max-w-4xl border border-gray-200">
    <h1 class="text-2xl font-semibold text-gray-800 mb-6 text-center">
        Generar KUDE (PDF)
    </h1>

    <form onsubmit="enviarXML(event)" class="space-y-5">
        <label class="block text-gray-700 font-medium">Pegar XML:</label>
        <textarea
                id="xml"
                rows="8"
                class="w-full p-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-400 focus:outline-none font-mono"
                placeholder="Pegá aquí el XML..."></textarea>

        <div class="text-center text-gray-600 font-medium">— ó —</div>

        <label class="block text-gray-700 font-medium">Subir archivo XML:</label>
        <input
                id="xmlFile"
                type="file"
                accept=".xml"
                class="w-full border border-gray-300 p-3 rounded-xl bg-gray-50 cursor-pointer"
        />

        <button
                type="submit"
                class="w-full bg-blue-600 hover:bg-blue-700 text-white py-4 rounded-xl font-medium transition shadow-md text-lg"
        >
            Descargar PDF
        </button>
    </form>
</div>
</body>
</html>